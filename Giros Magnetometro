#include <Wire.h>
#include <Adafruit_Sensor.h>
#include <Adafruit_HMC5883_U.h>

Adafruit_HMC5883_Unified mag = Adafruit_HMC5883_Unified(12345); 

byte Aa = 4; //motor adelante derecha
byte Ab = 5; //motor adelante derecha
byte Ba = 2; //motor atras derecha
byte Bb = 3; //motor atras derecha
byte Ca = 6; //motor adelante izq
byte Cb = 7; //motor adelante izq 
byte Da = 8; //motor atras izq
byte Db = 9; //motor atras izq  

int Avel = 255; // Adelante, derrecha.
int Bvel = 255; // Atras, derecha.
int Cvel = 238; // Adelante, izquerda.   (Siempre hay que disminuir en 17 los motores izquierdos.)
int Dvel = 238; // Atras, izquierda.

void setup() {
  Serial.begin (9600);
  pinMode (Aa, OUTPUT);
  pinMode (Ab, OUTPUT);
  pinMode (Ba, OUTPUT);
  pinMode (Bb, OUTPUT);
  pinMode (Ca, OUTPUT);
  pinMode (Cb, OUTPUT);
  pinMode (Da, OUTPUT);
  pinMode (Db, OUTPUT); 
 // Tampoco lo entendemos
   if(!mag.begin())
  {
    Serial.println("Ooops, no HMC5883 detected ... Check your wiring!");
    while(1);
  } 

 //Pero funciona
} 

//Magnetometro, (no lo entendemos pero funciona) 
//Magnetometro, (no lo entendemos pero funciona) 
//Magnetometro, (no lo entendemos pero funciona) 
//Magnetometro, (no lo entendemos pero funciona) 

float heading() 
{
  sensors_event_t event; 
  mag.getEvent(&event);
  float heading = atan2(event.magnetic.y, event.magnetic.x);
  float declinationAngle = 0.087;
  heading += declinationAngle;
  if(heading < 0)
    heading += 2*PI;
  if(heading > 2*PI)
    heading -= 2*PI;
  int headingDegrees = heading * 180/M_PI; 
  delay(30);
  return headingDegrees;
} 

// (Despues de esta parte si entendemos) 
// (Despues de esta parte si entendemos) 
// (Despues de esta parte si entendemos) 
// (Despues de esta parte si entendemos)

// Motores avnazan 

void avanzar(){ 
  
  analogWrite (Aa, Avel);
  analogWrite (Ab, LOW);
  
  analogWrite (Ba, Bvel);
  analogWrite (Bb, LOW);
  
  analogWrite (Ca, Cvel);
  analogWrite (Cb, LOW); 
  
  analogWrite (Da, Dvel);
  analogWrite (Db, LOW);
}

// Motores de detienen 

void detenerse(){ 
  
  analogWrite (Aa, LOW);
  analogWrite (Ab, Avel);
  
  analogWrite (Ba, LOW);
  analogWrite (Bb, Bvel);
  
  analogWrite (Ca, LOW);
  analogWrite (Cb, Cvel); 
  
  analogWrite (Da, LOW);
  analogWrite (Db, Dvel);  

  delay(100); // ABS

  analogWrite (Aa, LOW);
  analogWrite (Ab, LOW);
  
  analogWrite (Ba, LOW);
  analogWrite (Bb, LOW);
  
  analogWrite (Ca, LOW);
  analogWrite (Cb, LOW); 
  
  analogWrite (Da, LOW);
  analogWrite (Db, LOW);
} 

//Motores a la izquierda

void vueltaIzquierda() 
{ 
  analogWrite (Aa, Avel); //HIGH
  analogWrite (Ab, LOW);  //LOW
  analogWrite (Ba, Bvel); //HIGH
  analogWrite (Bb, LOW);  //LOW
  analogWrite (Ca, LOW);  //LOW
  analogWrite (Cb, Cvel); //HIGH 
  analogWrite (Da, LOW);  //LOW
  analogWrite (Db, Dvel); //HIGH
} 

//Motores a la derecha

void vueltaDerecha()
{ 
  analogWrite (Aa, LOW);  //LOW
  analogWrite (Ab, Avel); //HIGH
  analogWrite (Ba, LOW);  //LOW
  analogWrite (Bb, Bvel); //HIGH
  analogWrite (Ca, Cvel); //HIGH
  analogWrite (Cb, LOW);  //LOW
  analogWrite (Da, Dvel); //HIGH
  analogWrite (Db, LOW);  //LOW
} 

void loop() {  



 Serial.println(heading());

}
