#include <math.h>
#include <Wire.h>
#include <Adafruit_Sensor.h>
#include <Adafruit_HMC5883_U.h>

Adafruit_HMC5883_Unified mag = Adafruit_HMC5883_Unified(12345); 

byte Aa = 4; //motor adelante derecha
byte Ab = 5; //motor adelante derecha
byte Ba = 2; //motor atras derecha
byte Bb = 3; //motor atras derecha
byte Ca = 6; //motor adelante izq 
byte Cb = 7; //motor adelante izq 
byte Da = 8; //motor atras izq
byte Db = 9; //motor atras izq  
const int s0 = 51;  
const int s1 = 49;  
const int s2 = 50;  
const int s3 = 48;  
const int out = 52;  
byte SenIzqTrig = 43; //sensor ultrasonico izquierdo trigger
byte SenIzqEch = 42; //sensor ultrasonico izquierdo echo
byte SenDerTrig = 45;  //sensor ultrasonico derecha trigger
byte SenDerEch = 44;//sensor ultrasonico derecha echo
byte SenEnfEch = 46; //sensor ultrasonico frontal echo
byte SenEnfTrig = 47; //sensor ultrasonico frontal trigger



int Avel = 255; // Adelante, derrecha.
int Bvel = 255; // Atras, derecha.
int Cvel = 238; // Adelante, izquerda.   (Siempre hay que disminuir en 17 los motores izquierdos.)
int Dvel = 238; // Atras, izquierda.
int red = 0;  
int green = 0;  
int blue = 0;  
String colon = "";
long tiempo; // Variable para los ultrasonicos
long DistanciaSenEnfrente, DistanciaSenDerecha, DistanciaSenIzquierdo;//Variable para la distancia
int LedR = 10;
int LedG = 9;
int LedB = 8;

void setup() {
  Serial.begin (9600);
  pinMode (Aa, OUTPUT);
  pinMode (Ab, OUTPUT);
  pinMode (Ba, OUTPUT);
  pinMode (Bb, OUTPUT);
  pinMode (Ca, OUTPUT);
  pinMode (Cb, OUTPUT);
  pinMode (Da, OUTPUT);
  pinMode (Db, OUTPUT); 
  pinMode(s0, OUTPUT);  
  pinMode(s1, OUTPUT);  
  pinMode(s2, OUTPUT);  
  pinMode(s3, OUTPUT);  
  pinMode(out, INPUT);  
  pinMode(SenIzqEch, INPUT);
  pinMode(SenDerEch, INPUT);
  pinMode(SenEnfEch, INPUT);
  pinMode(SenIzqTrig, OUTPUT);
  pinMode(SenDerTrig, OUTPUT);
  pinMode(SenEnfTrig, OUTPUT);
  pinMode(LedR, OUTPUT);
  pinMode(LedG, OUTPUT);
  pinMode(LedB, OUTPUT);
  digitalWrite(s0, HIGH);  
  digitalWrite(s1, HIGH);
  digitalWrite(LedR, LOW);
  digitalWrite(LedG, LOW);
  digitalWrite(LedB, LOW);
 // Tampoco lo entendemos
   if(!mag.begin())
  {
    Serial.println("Ooops, no HMC5883 detected ... Check your wiring!");
    while(1);
  } 

 //Pero funciona
} 

//Magnetometro, (no lo entendemos pero funciona) 
//Magnetometro, (no lo entendemos pero funciona) 
//Magnetometro, (no lo entendemos pero funciona) 
//Magnetometro, (no lo entendemos pero funciona) 

int heading() 
{
  sensors_event_t event; 
  mag.getEvent(&event);
  float heading = atan2(event.magnetic.y, event.magnetic.x);
  float declinationAngle = 0.087;
  heading += declinationAngle;
  if(heading < 0)
    heading += 2*PI;
  if(heading > 2*PI)
    heading -= 2*PI;
  int headingDegrees = heading * 180/M_PI; 
  if (headingDegrees<=86)
  {
    headingDegrees=map(headingDegrees,0,86,0,90); 
  }
    if (headingDegrees<=200 && headingDegrees>86)
  {
    headingDegrees=map(headingDegrees,87,200,91,180); 
  }
     if (headingDegrees<=289 && headingDegrees>200)
  {
    headingDegrees=map(headingDegrees,201,289,181,270); 
  }
       if (headingDegrees<=359 && headingDegrees>289)
  {
    headingDegrees=map(headingDegrees,290,359,271,359); 
  }
  //delay(5);
  return headingDegrees;
} 

// (Despues de esta parte si entendemos) 
// (Despues de esta parte si entendemos) 
// (Despues de esta parte si entendemos) 
// (Despues de esta parte si entendemos)

// Motores avnazan 

void avanzar(){ 
  
  analogWrite (Aa, Avel);
  analogWrite (Ab, LOW);
  
  analogWrite (Ba, Bvel);
  analogWrite (Bb, LOW);
  
  analogWrite (Ca, Cvel);
  analogWrite (Cb, LOW); 
  
  analogWrite (Da, Dvel);
  analogWrite (Db, LOW);
}

// Motores avanzan 

void avanzar30 ()
{
  byte Astop = 150;
  
  analogWrite (Aa, Avel);
  analogWrite (Ab, LOW);
  
  analogWrite (Ba, Bvel);
  analogWrite (Bb, LOW);
  
  analogWrite (Ca, Cvel);
  analogWrite (Cb, LOW); 
  
  analogWrite (Da, Dvel);
  analogWrite (Db, LOW);
  delay (240);
  
  for (int iI=1; Astop > iI; Astop --)
  {
    analogWrite (Aa, Astop);
    analogWrite (Ab, LOW);
    
    analogWrite (Ba, Astop);
    analogWrite (Bb, LOW);
    
    analogWrite (Ca, Astop);
    analogWrite (Cb, LOW); 
    
    analogWrite (Da, Astop);
    analogWrite (Db, LOW);
    
    delayMicroseconds(347);
  }
  detenerse();
}

// Motores de detienen 

void detenerse(){ 
  
  analogWrite (Aa, LOW);
  analogWrite (Ab, LOW);
  
  analogWrite (Ba, LOW);
  analogWrite (Bb, LOW);
  
  analogWrite (Ca, LOW);
  analogWrite (Cb, LOW); 
  
  analogWrite (Da, LOW);
  analogWrite (Db, LOW); 

  delay(125); // ABSr

  
  analogWrite (Aa, LOW);
  analogWrite (Ab, Avel);
  
  analogWrite (Ba, LOW);
  analogWrite (Bb, Bvel);
  
  analogWrite (Ca, LOW);
  analogWrite (Cb, Cvel); 
  
  analogWrite (Da, LOW);
  analogWrite (Db, Dvel);   

  delay(125);

  analogWrite (Aa, LOW);
  analogWrite (Ab, LOW);
  
  analogWrite (Ba, LOW);
  analogWrite (Bb, LOW);
  
  analogWrite (Ca, LOW);
  analogWrite (Cb, LOW); 
  
  analogWrite (Da, LOW);
  analogWrite (Db, LOW);
}

void PararCurva()
{
  analogWrite (Aa, LOW);
  analogWrite (Ab, LOW);
  
  analogWrite (Ba, LOW);
  analogWrite (Bb, LOW);
  
  analogWrite (Ca, LOW);
  analogWrite (Cb, LOW); 
  
  analogWrite (Da, LOW);
  analogWrite (Db, LOW);
}

void detenerse2rd(){ 
  analogWrite (Aa, LOW);
  analogWrite (Ab, Avel);
  
  analogWrite (Ba, LOW);
  analogWrite (Bb, Bvel);
  
  analogWrite (Ca, LOW);
  analogWrite (Cb, Cvel); 
  
  analogWrite (Da, LOW);
  analogWrite (Db, Dvel);

  delay (1);
  //ABS
  
  analogWrite (Aa, LOW);
  analogWrite (Ab, LOW);
  
  analogWrite (Ba, LOW);
  analogWrite (Bb, LOW);
  
  analogWrite (Ca, LOW);
  analogWrite (Cb, LOW); 
  
  analogWrite (Da, LOW);
  analogWrite (Db, LOW);
}  


//Motores a la izquierda

void vueltaIzquierda() 
{ 
  analogWrite (Aa, 190); //HIGH
  analogWrite (Ab, LOW);  //LOW
  analogWrite (Ba, 155); //HIGH
  analogWrite (Bb, LOW);  //LOW
  
  analogWrite (Ca, LOW);  //LOW
  analogWrite (Cb, 155); //HIGH 
  analogWrite (Da, LOW);  //LOW
  analogWrite (Db, 110); //HIGH
} 

//Motores a la derecha

void vueltaDerecha()
{ 
  analogWrite (Aa, LOW);  //LOW
  analogWrite (Ab, 110); //HIGH
  analogWrite (Ba, LOW);  //LOW
  analogWrite (Bb, 110); //HIGH
  analogWrite (Ca, 110); //HIGH
  analogWrite (Cb, LOW);  //LOW
  analogWrite (Da, 110); //HIGH
  analogWrite (Db, LOW);  //LOW
}

void derecha90()
{
  int g1 = heading();
  int g2 = g1 + 90;
  if(g2 > 360)
  {
    g2 -= 360;
  }
  bool cont = false;
  while (cont == false)
  {
    if(g1 <= g2)
    {
      vueltaDerecha();
      g1 = heading();
      if(g1 >= g2)
      {
        cont = true;
      }
    }
    else if(g1 > g2)
    {
      vueltaDerecha();
      g1=heading();
    }
  }
  PararCurva();
}

 
void derecha270()
{
  int g1 = heading();
  int g2 = g1 - 90;
  if(g2 < 0)
  {
    g2 += 360;
  }
  bool cont = false;
  while(cont == false)
  {
    if(g1 <= g2)
    {
      if(g1 >= g2)
      {
        cont = true;
      }
      vueltaDerecha();
      g1 = heading();
    }
    else if(g1 > g2)
    {
      vueltaDerecha();
      g1 = heading();
    }
  }
  detenerse();
}

void izquierda90()
{
  int g1=heading();
  int g2=g1 - 90;
  if(g2 < 0)
  {
    g2 += 360;
  }
  bool cont = false;

  while(cont == false)
  {
    if (g1 >= g2)
    {
      if(g1 <= g2)
      {
        cont = true;
      }
      vueltaIzquierda();
      g1 = heading();
      
    }
    else if(g1 < g2)
    {
      vueltaIzquierda();
      g1=heading();
    }
  }
  detenerse();
}

void izquierda270()
{
  int g1 = heading();
  int g2 = g1 + 90;
  if (g2 > 360)
  {
    g2 -= 360;
  }
  bool cont = false;
  while(cont == false)
  {
    if( g1 >= g2)
    {
      if(g1 <= g2)
      {
        cont = true;
      }
      vueltaIzquierda();
      g1 = heading();
    }
    else if(g1 < g2)
    {
      vueltaIzquierda();
      g1 = heading();
    }
  }
  detenerse();
}

String color()  
{    
  digitalWrite(s2, LOW);  
  digitalWrite(s3, LOW);  
  //count OUT, pRed, RED  
  red = pulseIn(out, digitalRead(out) == HIGH ? LOW : HIGH);  
  digitalWrite(s3, HIGH);  
  //count OUT, pBLUE, BLUE  
  blue = pulseIn(out, digitalRead(out) == HIGH ? LOW : HIGH);  
  digitalWrite(s2, HIGH);  
  //count OUT, pGreen, GREEN  
  green = pulseIn(out, digitalRead(out) == HIGH ? LOW : HIGH); 

  /*Serial.println("red: ");
  Serial.println(red);
  Serial.println("green: ");
  Serial.println(green);
  Serial.println("blue: ");
  Serial.println(blue);*/
  
   if ((green >= 19 && green <= 25) && (blue >= 15 && blue <= 19) && (red >= 22 &&  red <= 27))
  {
    colon = "white";
  
      digitalWrite(LedR, LOW);
  digitalWrite(LedG, LOW);
  digitalWrite(LedB, LOW);
  }
  else if ((green > 82 && green < 95) && (blue > 70 && blue < 84) && (red > 145 &&  red < 172))
  {
      digitalWrite(LedR, LOW);
  digitalWrite(LedG, LOW);
  digitalWrite(LedB, LOW);
    colon = "green";
    digitalWrite(LedG, HIGH);
  }
  else if ((green > 155 && green < 162) && (blue > 100 && blue < 112) && (red > 190 &&  red < 200))
  {
    colon = "black";
  }
  else if ((green > 85 && green < 99) && (blue > 63 && blue < 72) && (red > 36 &&  red < 42))
  {
      digitalWrite(LedR, LOW);
  digitalWrite(LedG, LOW);
  digitalWrite(LedB, LOW);
    colon = "red";
     digitalWrite(LedR, HIGH);
  }
  return colon;
}

int SensorDerecha () //funcion para sensor ultrasonico derecha
{
  long SumaDistancias = 0;
 long Distancia1 = 0;
 long  Distancia2 = 0;
 long Distancia3 = 0;
 int iI;
 
  for (iI=1; iI<=3; iI++)
  {
    digitalWrite(45, LOW);
    delayMicroseconds(5);
    digitalWrite(45, HIGH);  
    delayMicroseconds(10);
    tiempo=pulseIn(44, HIGH);
    delayMicroseconds(50);
    if ( iI==1 )
    {
      Distancia1 = int(0.017*tiempo);
    }
    else if ( iI== 2 )
    {
      Distancia2 = int(0.017*tiempo);
    }
    else if ( iI==3 )
    {
      Distancia3 = int(0.017*tiempo);
    }
   }

  if (Distancia1 > Distancia2 && Distancia1 > Distancia3)
  {
    if (Distancia2 > Distancia3)
    {
      DistanciaSenDerecha = Distancia2;
    }
    else
    {
      DistanciaSenDerecha = Distancia3;
    }
  }
  if (Distancia2 > Distancia1 && Distancia2 > Distancia3)
  {
    if (Distancia1 > Distancia3)
    {
      DistanciaSenDerecha = Distancia1;
    }
    else
    {
      DistanciaSenDerecha = Distancia3;
    }
  }
  if (Distancia3 > Distancia1 && Distancia3 > Distancia2)
  {
    if (Distancia2 > Distancia1)
    {
      DistanciaSenDerecha = Distancia2;
    }  
    else 
    {
      DistanciaSenDerecha = Distancia1;
    }
  }
  if (Distancia1 == Distancia2)
  {
   DistanciaSenDerecha=Distancia1;
  }
  if (Distancia1 == Distancia3)
  {
   DistanciaSenDerecha=Distancia1;
  }
  if (Distancia2 == Distancia3)
  {
   DistanciaSenDerecha=Distancia2;
  }
    if (Distancia2 == Distancia1)
  {
   DistanciaSenDerecha=Distancia2;
  }

  return DistanciaSenDerecha;
}

int SensorFrontal() //funcion para sensor ultrasonico frontal
{
 long SumaDistancias = 0;
 long Distancia1 = 0;
 long  Distancia2 = 0;
 long Distancia3 = 0;
 int iI;
 
  for (iI=1; iI<=3; iI++)
  {
    digitalWrite(47, LOW);
    delayMicroseconds(5);
    digitalWrite(47, HIGH);  
    delayMicroseconds(10);
    tiempo=pulseIn(46, HIGH);
    delayMicroseconds(50);
    if ( iI==1 )
    {
      Distancia1 = int(0.017*tiempo);
    }
    else if ( iI== 2 )
    {
      Distancia2 = int(0.017*tiempo);
    }
    else if ( iI==3 )
    {
      Distancia3 = int(0.017*tiempo);
    }
   }

  if (Distancia1 > Distancia2 && Distancia1 > Distancia3)
  {
    if (Distancia2 > Distancia3)
    {
      DistanciaSenEnfrente = Distancia2;
    }
    else
    {
      DistanciaSenEnfrente = Distancia3;
    }
  }
  if (Distancia2 > Distancia1 && Distancia2 > Distancia3)
  {
    if (Distancia1 > Distancia3)
    {
      DistanciaSenEnfrente = Distancia1;
    }
    else
    {
      DistanciaSenEnfrente = Distancia3;
    }
  }
  if (Distancia3 > Distancia1 && Distancia3 > Distancia2)
  {
    if (Distancia2 > Distancia1)
    {
      DistanciaSenEnfrente = Distancia2;
    }
    else 
    {
      DistanciaSenEnfrente = Distancia1;
    }
  }
  if (Distancia1 == Distancia2)
  {
   DistanciaSenEnfrente=Distancia1;
  }
  if (Distancia1 == Distancia3)
  {
   DistanciaSenEnfrente=Distancia1;
  }
  if (Distancia2 == Distancia3)
  {
   DistanciaSenEnfrente=Distancia2;
  }
    if (Distancia2 == Distancia1)
  {
   DistanciaSenEnfrente=Distancia2;
  }
 return DistanciaSenEnfrente;
}

int SensorIzquierdo () //funcion para sensor izquierdo
{
 long SumaDistancias = 0;
 long Distancia1 = 0;
 long  Distancia2 = 0;
 long Distancia3 = 0;
 long DistanciaSenIzquierdo = 0;
 int iI;
 
  for (iI=1; iI<=3; iI++)
  {
    digitalWrite(43, LOW);
    delayMicroseconds(5);
    digitalWrite(43, HIGH);  
    delayMicroseconds(10);
    tiempo=pulseIn(42, HIGH);
    delayMicroseconds(50);
    if ( iI==1 )
    {
      Distancia1 = int(0.017*tiempo);
    }
 return DistanciaSenIzquierdo;
}
}

void adelante30()
{
  int iPos = SensorFrontal();
  int iDist = iPos - 30;

  Serial.println("iPos: ");
  Serial.println(iPos);
  Serial.println("iDist: ");
  Serial.println(iDist);

  while(iPos > iDist)
  {
    avanzar();
   Serial.println("iPos: ");
  Serial.println(iPos);
  Serial.println("iDist: ");
  Serial.println(iDist);
    iPos = SensorFrontal();
  }
  detenerse();
}

void adelantetiempo()
{
  avanzar();
  delay(26);
  analogWrite (Aa, LOW);
  analogWrite (Ab, LOW);
  
  analogWrite (Ba, LOW);
  analogWrite (Bb, LOW);
  
  analogWrite (Ca, LOW);
  analogWrite (Cb, LOW); 
  
  analogWrite (Da, LOW);
  analogWrite (Db, LOW);
  delay(26);
  detenerse();
}

void FinDer()
{
  adelantetiempo();
  detenerse();
  delay(10);
  String sColor = color();
  if (sColor == "red")
  {
    izquierda270();
  }
  else 
  {
    derecha90();
  }
  detenerse();
  delay(10);
}

void FinIzq()
{
  String sColor = color();
  if(sColor == "green")
  {
    derecha270();
  }
  else
  {
    izquierda90();
  }
  detenerse();
  delay(10);
}

void Empieza()
{
  int iDistancia = SensorFrontal();
  String sColor = color();
  while (iDistancia > 5)
  {
    avanzar();

    if (sColor == "red")
    {
      digitalWrite(LedR, HIGH);
    }
    if (sColor == "green")
    {
      digitalWrite(LedG, HIGH);
    }
    sColor = color();
    iDistancia == SensorFrontal();
  }
  detenerse();
  delay(10);
  sColor = color();
  if (sColor == "red")
  {
    izquierda270();
  }
  else 
  {
    derecha90();
  }
  detenerse();
  delay(10);
}

void continua()
{
  int iDistancia = SensorFrontal();
  String sColor = color();
  while (iDistancia > 5)
  {
    sColor = color();
    avanzar();

    if (sColor == "red")
    {
      digitalWrite(LedR, HIGH);
    }
    if (sColor == "green")
    {
      digitalWrite(LedG, HIGH);
    }
    iDistancia == SensorFrontal();
    sColor = color();
  }
  detenerse();
  delay(10);
  sColor = color();
  if(sColor == "green")
  {
    derecha270();
  }
  else
  {
    izquierda90();
  }
  detenerse();
  delay(10);
  adelantetiempo();
  detenerse();
  delay(10);
}

void regreso()
{
  String sColor = color();
  if (sColor == "red")
  {
    izquierda270();
    detenerse();
    delay(10);
  }
  else
  {
    derecha90();
    detenerse();
    delay(10);
  }
  sColor = color();
  while (sColor != "plateado")
  {
    avanzar();
    sColor = color();
    if (sColor == "red")
    {
      digitalWrite(LedR, HIGH);
    }
    if (sColor == "green")
    {
      digitalWrite(LedG, HIGH);
    }
  }
  detenerse();
  delay(10);
}


void SecUno()
{
    Empieza();
    FinDer();
    continua();
    FinIzq();
    Empieza();
    FinDer();
    continua();
    regreso();
}
void adelantetiempo2()
{
  avanzar();
  delay(450);
  detenerse();
}

void loop() {
  // put your main code here, to run repeatedly:
  color();
}
